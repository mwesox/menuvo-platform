name: Deploy Pages

on:
  push:
    branches: [main]
    paths:
      - "apps/console/**"
      - "apps/shop/**"
      - "apps/business/**"
      - "packages/ui/**"
      - "packages/trpc/**"
      - ".github/workflows/deploy-pages.yml"
  workflow_dispatch:
    inputs:
      app:
        description: "App to deploy (console, shop, business, or all)"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - console
          - shop
          - business

env:
  VITE_API_URL: https://api.menuvo.app

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      console: ${{ steps.filter.outputs.console }}
      shop: ${{ steps.filter.outputs.shop }}
      business: ${{ steps.filter.outputs.business }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            console:
              - 'apps/console/**'
              - 'packages/ui/**'
              - 'packages/trpc/**'
            shop:
              - 'apps/shop/**'
              - 'packages/ui/**'
              - 'packages/trpc/**'
            business:
              - 'apps/business/**'
              - 'packages/ui/**'
              - 'packages/trpc/**'

  deploy-console:
    name: Deploy Console
    runs-on: ubuntu-latest
    needs: changes
    if: |
      github.event_name == 'workflow_dispatch' && (github.event.inputs.app == 'all' || github.event.inputs.app == 'console') ||
      github.event_name == 'push' && needs.changes.outputs.console == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build Console
        run: bun run --filter @menuvo/console build
        env:
          VITE_API_URL: ${{ env.VITE_API_URL }}
          VITE_STRIPE_PUBLISHABLE_KEY: ${{ secrets.VITE_STRIPE_PUBLISHABLE_KEY }}
          VITE_SENTRY_DSN: ${{ secrets.VITE_SENTRY_DSN }}

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy apps/console/dist --project-name=menuvo-console --branch=main

  deploy-shop:
    name: Deploy Shop
    runs-on: ubuntu-latest
    needs: changes
    if: |
      github.event_name == 'workflow_dispatch' && (github.event.inputs.app == 'all' || github.event.inputs.app == 'shop') ||
      github.event_name == 'push' && needs.changes.outputs.shop == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build Shop
        run: bun run --filter @menuvo/shop build
        env:
          VITE_API_URL: ${{ env.VITE_API_URL }}
          VITE_STRIPE_PUBLISHABLE_KEY: ${{ secrets.VITE_STRIPE_PUBLISHABLE_KEY }}
          VITE_SENTRY_DSN: ${{ secrets.VITE_SENTRY_DSN }}

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy apps/shop/dist --project-name=menuvo-shop --branch=main

  deploy-business:
    name: Deploy Business
    runs-on: ubuntu-latest
    needs: changes
    if: |
      github.event_name == 'workflow_dispatch' && (github.event.inputs.app == 'all' || github.event.inputs.app == 'business') ||
      github.event_name == 'push' && needs.changes.outputs.business == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build Business
        run: bun run --filter @menuvo/business build
        env:
          VITE_API_URL: ${{ env.VITE_API_URL }}
          VITE_SENTRY_DSN: ${{ secrets.VITE_SENTRY_DSN }}

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy apps/business/dist --project-name=menuvo-business-site --branch=main
