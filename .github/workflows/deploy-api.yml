name: Deploy API

on:
  push:
    branches: [main]
    paths:
      - "apps/api/**"
      - "packages/db/**"
      - "packages/trpc/**"
      - "infra/**"
      - ".github/workflows/deploy-api.yml"
  workflow_dispatch:
    inputs:
      no-cache:
        description: "Build without Docker cache"
        required: false
        default: false
        type: boolean

jobs:
  build-push:
    name: Build & Push API Image
    runs-on: hetzner-vps
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker BuildX
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/mwesox/menuvo-api
          tags: |
            type=sha
            type=ref,event=branch
            type=raw,value=${{ github.sha }}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: infra/Dockerfile.api
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: ${{ inputs.no-cache && '' || 'type=registry,ref=ghcr.io/mwesox/menuvo-api:buildcache' }}
          cache-to: type=registry,ref=ghcr.io/mwesox/menuvo-api:buildcache,mode=max
          provenance: false

  deploy:
    name: Deploy to VPS
    runs-on: hetzner-vps
    needs: [build-push]
    environment: production
    concurrency:
      group: deploy-api-${{ github.ref }}
      cancel-in-progress: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create .env file
        run: |
          cat > /home/deploy/menuvo/.env << 'EOF'
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          AUTH_SECRET=${{ secrets.AUTH_SECRET }}
          S3_ENDPOINT=${{ secrets.S3_ENDPOINT }}
          S3_ACCESS_KEY_ID=${{ secrets.S3_ACCESS_KEY_ID }}
          S3_SECRET_ACCESS_KEY=${{ secrets.S3_SECRET_ACCESS_KEY }}
          S3_BUCKET=${{ secrets.S3_BUCKET }}
          S3_FILES_BUCKET=${{ secrets.S3_FILES_BUCKET }}
          S3_BASE_URL=${{ secrets.S3_BASE_URL }}
          S3_REGION=${{ secrets.S3_REGION }}
          STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }}
          STRIPE_WEBHOOK_SECRET_THIN=${{ secrets.STRIPE_WEBHOOK_SECRET_THIN }}
          OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}
          BESZEL_AGENT_KEY=${{ secrets.BESZEL_AGENT_KEY }}
          GATUS_TELEGRAM_TOKEN=${{ secrets.GATUS_TELEGRAM_TOKEN }}
          GATUS_TELEGRAM_CHAT_ID=${{ secrets.GATUS_TELEGRAM_CHAT_ID }}
          BACKUP_S3_BUCKET=${{ secrets.BACKUP_S3_BUCKET }}
          BACKUP_S3_PREFIX=${{ secrets.BACKUP_S3_PREFIX }}
          BACKUP_S3_ENDPOINT=${{ secrets.BACKUP_S3_ENDPOINT }}
          BACKUP_S3_REGION=${{ secrets.BACKUP_S3_REGION }}
          BACKUP_S3_ACCESS_KEY_ID=${{ secrets.BACKUP_S3_ACCESS_KEY_ID }}
          BACKUP_S3_SECRET_ACCESS_KEY=${{ secrets.BACKUP_S3_SECRET_ACCESS_KEY }}
          BACKUP_KEEP_DAYS=${{ secrets.BACKUP_KEEP_DAYS }}
          BACKUP_CRON="${{ secrets.BACKUP_CRON }}"
          MOLLIE_API_KEY=${{ secrets.MOLLIE_API_KEY }}
          MOLLIE_TEST_MODE=${{ secrets.MOLLIE_TEST_MODE }}
          VERSION=${{ github.sha }}
          EOF

      - name: Copy configuration files
        run: |
          cp infra/docker-compose.yml /home/deploy/menuvo/
          cp infra/Caddyfile /home/deploy/menuvo/
          cp infra/Dockerfile.caddy /home/deploy/menuvo/
          cp infra/Dockerfile.backup /home/deploy/menuvo/
          cp infra/backup.sh /home/deploy/menuvo/
          cp infra/backup-entrypoint.sh /home/deploy/menuvo/
          cp infra/gatus.yaml /home/deploy/menuvo/

      - name: Rebuild Caddy and backup image
        run: |
          cd /home/deploy/menuvo
          docker compose build caddy postgres-backup
          docker compose up -d --no-deps --force-recreate caddy

      - name: Ensure core services are running
        run: |
          cd /home/deploy/menuvo
          docker compose up -d postgres redis

      - name: Pull application images
        run: |
          cd /home/deploy/menuvo
          docker compose pull api-a api-b

      - name: Run database migrations
        run: |
          cd /home/deploy/menuvo
          docker compose run --rm -w /app/packages/db api-a bunx drizzle-kit migrate

      - name: Rolling deploy API
        run: |
          cd /home/deploy/menuvo

          wait_for_health() {
            service="$1"
            for i in $(seq 1 30); do
              cid="$(docker compose ps -q "$service")"
              if [ -n "$cid" ]; then
                status="$(docker inspect -f '{{.State.Health.Status}}' "$cid" 2>/dev/null || echo starting)"
                if [ "$status" = "healthy" ]; then
                  echo "OK: $service is healthy"
                  return 0
                fi
              fi
              echo "Waiting for $service to be healthy ($i/30)..."
              sleep 5
            done
            echo "FAILED: $service did not become healthy"
            docker compose logs --tail=200 "$service"
            exit 1
          }

          docker compose up -d api-a
          wait_for_health api-a

          docker compose up -d api-b
          wait_for_health api-b

      - name: Deploy backup and monitoring
        run: |
          cd /home/deploy/menuvo
          docker compose up -d postgres-backup
          docker compose up -d --no-deps --force-recreate gatus

      - name: Health checks
        run: |
          echo "Checking api.menuvo.app..."
          for i in {1..12}; do
            if curl -sf https://api.menuvo.app/health > /dev/null 2>&1; then
              echo "OK: api.menuvo.app is healthy"
              break
            fi
            if [ $i -eq 12 ]; then
              echo "FAILED: api.menuvo.app health check failed"
              exit 1
            fi
            echo "Attempt $i/12 - waiting..."
            sleep 5
          done
