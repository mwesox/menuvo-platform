# Menuvo Production Caddyfile
# TanStack Start Platform (Console + Shop)
# Automatic HTTPS with Let's Encrypt
#
# All routes served by TanStack Start platform container

# Global options (MUST be first!)
{
	# Email for Let's Encrypt
	email admin@menuvo.app

	# Order of handlers (rate_limit must come first)
	order rate_limit before basicauth
}

# Shop - Discovery, Store, Cart, Checkout (menuvo.app, www.menuvo.app)
menuvo.app, www.menuvo.app {
	# Proxy /api/* requests to platform container (remote functions)
	@api {
		path /api/*
	}
	reverse_proxy @api menuvo-platform:3000 {
		# Timeouts
		transport http {
			dial_timeout 10s
			read_timeout 30s
			write_timeout 30s
		}

		# Forward headers
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-For {remote_host}
		header_up X-Forwarded-Proto {scheme}
	}

	# Rate limiting - Auth endpoints (10 req/min per IP)
	@auth_endpoints {
		path /auth/*
		path /api/auth/*
	}
	rate_limit @auth_endpoints {
		zone auth_zone {
			key {remote_host}
			events 10
			window 1m
		}
	}

	# Rate limiting - Order endpoints (30 req/min per IP)
	@order_endpoints {
		path /shop/*/orders*
		path /api/*/orders*
	}
	rate_limit @order_endpoints {
		zone order_zone {
			key {remote_host}
			events 30
			window 1m
		}
	}

	# Rate limiting - Global API (100 req/min per IP)
	@global_api {
		path /api/*
	}
	rate_limit @global_api {
		zone global_api_zone {
			key {remote_host}
			events 100
			window 1m
		}
	}

	# Reverse proxy all other requests to TanStack Start platform
	reverse_proxy menuvo-platform:3000 {
		# Health check
		health_interval 30s
		health_timeout 10s

		# Timeouts
		transport http {
			dial_timeout 10s
			read_timeout 30s
			write_timeout 30s
		}

		# Forward headers
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-For {remote_host}
		header_up X-Forwarded-Proto {scheme}
	}

	# Security headers
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		X-XSS-Protection "1; mode=block"
		Referrer-Policy "strict-origin-when-cross-origin"

		# CSP - Allow images from external CDN, API calls to self
		Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https:; font-src 'self' data: https://fonts.gstatic.com; connect-src 'self' https://api.menuvo.app wss://menuvo.app https://menuvo.app"

		# Remove server identification
		-Server
	}

	# Logging
	log {
		output file /var/log/caddy/shop.log
		format json
		level INFO
	}

	# Enable compression
	encode gzip zstd
}

# Console - Merchant Dashboard (console.menuvo.app)
console.menuvo.app {
	# Proxy all requests to platform container
	reverse_proxy menuvo-platform:3000 {
		# Health check
		health_uri /health
		health_interval 30s
		health_timeout 10s

		# Timeouts
		transport http {
			dial_timeout 10s
			read_timeout 30s
			write_timeout 30s
		}

		# Forward headers
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-For {remote_host}
		header_up X-Forwarded-Proto {scheme}
		header_up X-Forwarded-Host {host}
	}

	# Rate limiting - Console is merchant-facing, less traffic expected
	rate_limit {
		zone console_zone {
			key {remote_host}
			events 200
			window 1m
		}
	}

	# Security headers - Stricter for merchant dashboard
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "DENY"
		X-XSS-Protection "1; mode=block"
		Referrer-Policy "strict-origin-when-cross-origin"

		# Stricter CSP for console
		Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self'"

		# Remove server identification
		-Server
	}

	# Logging
	log {
		output file /var/log/caddy/console.log
		format json
		level INFO
	}

	# Enable compression
	encode gzip zstd
}

# Beszel Monitoring Dashboard (monitor.menuvo.app)
monitor.menuvo.app {
	reverse_proxy menuvo-beszel:8090

	# Rate limiting - Monitoring dashboard
	rate_limit {
		zone beszel_zone {
			key {remote_host}
			events 100
			window 1m
		}
	}

	# Security headers
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "DENY"
		X-XSS-Protection "1; mode=block"
		-Server
	}

	# Logging
	log {
		output file /var/log/caddy/monitor.log
		format json
		level INFO
	}
}
