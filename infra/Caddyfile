# Menuvo Production Caddyfile
# TanStack Start Platform - Single domain routing
# All routes: menuvo.app/console, menuvo.app/shop, etc.

# Global options (MUST be first!)
{
	email admin@menuvo.app
	order rate_limit before basicauth
}

# Cloudflare proxy - use internal TLS
(cloudflare_tls) {
	tls internal
}

# Common reverse proxy settings
(proxy_settings) {
	transport http {
		dial_timeout 10s
		read_timeout 30s
		write_timeout 30s
	}
	header_up X-Real-IP {remote_host}
	header_up X-Forwarded-For {remote_host}
	header_up X-Forwarded-Proto {scheme}
}

# Main site - menuvo.app
menuvo.app, www.menuvo.app {
	import cloudflare_tls

	# Rate limiting
	@auth_endpoints path /auth/* /api/auth/*
	rate_limit @auth_endpoints {
		zone auth_zone {
			key {remote_host}
			events 10
			window 1m
		}
	}

	@api path /api/*
	rate_limit @api {
		zone api_zone {
			key {remote_host}
			events 100
			window 1m
		}
	}

	# Proxy all requests to platform
	reverse_proxy menuvo-platform:3000 {
		import proxy_settings
		health_interval 30s
		health_timeout 10s
	}

	# Security headers
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		X-XSS-Protection "1; mode=block"
		Referrer-Policy "strict-origin-when-cross-origin"
		-Server
	}

	log {
		output file /var/log/caddy/menuvo.log
		format json
		level INFO
	}

	encode gzip zstd
}

# Console subdomain - redirect to main domain
console.menuvo.app {
	import cloudflare_tls
	redir https://menuvo.app/console{uri} permanent
}

# Beszel Monitoring Dashboard
monitor.menuvo.app {
	import cloudflare_tls

	reverse_proxy menuvo-beszel:8090

	rate_limit {
		zone beszel_zone {
			key {remote_host}
			events 100
			window 1m
		}
	}

	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "DENY"
		X-XSS-Protection "1; mode=block"
		-Server
	}

	log {
		output file /var/log/caddy/monitor.log
		format json
		level INFO
	}
}
