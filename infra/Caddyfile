# Menuvo Production Caddyfile
# API-only deployment - SPAs on Cloudflare Pages
#
# Architecture:
#   - api.menuvo.app      → API (Hono + tRPC) - this server
#   - menuvo.app          → Shop (Cloudflare Pages)
#   - console.menuvo.app  → Console (Cloudflare Pages)
#   - business.menuvo.app → Business (Cloudflare Pages)
#   - status.menuvo.app   → Gatus (uptime monitoring)
#   - monitor.menuvo.app  → Beszel (host monitoring)

# Global options (MUST be first!)
{
	admin :2019
	email admin@menuvo.app
	order rate_limit before basicauth
	# Cloudflare trusted proxies (update from https://www.cloudflare.com/ips/)
	servers {
		trusted_proxies static 173.245.48.0/20 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 141.101.64.0/18 108.162.192.0/18 190.93.240.0/20 188.114.96.0/20 197.234.240.0/22 198.41.128.0/17 162.158.0.0/15 104.16.0.0/13 104.24.0.0/14 172.64.0.0/13 131.0.72.0/22 2400:cb00::/32 2606:4700::/32 2803:f800::/32 2405:b500::/32 2405:8100::/32 2a06:98c0::/29 2c0f:f248::/32
	}
}

# Cloudflare proxy - use internal TLS
(cloudflare_tls) {
	tls internal
}

# Common reverse proxy settings
(proxy_settings) {
	transport http {
		dial_timeout 10s
		read_timeout 30s
		write_timeout 30s
	}
	header_up X-Real-IP {client_ip}
	header_up X-Forwarded-For {client_ip}
	header_up X-Forwarded-Proto {scheme}
}

# Security headers
(security_headers) {
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "DENY"
		X-XSS-Protection "1; mode=block"
		Referrer-Policy "strict-origin-when-cross-origin"
		-Server
	}
}

# CORS for API (SPAs on different domains)
(cors_api) {
	@cors_preflight method OPTIONS
	handle @cors_preflight {
		header Access-Control-Allow-Origin "{header.Origin}"
		header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
		header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, X-TRPC-Source"
		header Access-Control-Allow-Credentials "true"
		header Access-Control-Max-Age "86400"
		respond "" 204
	}

	header Access-Control-Allow-Origin "{header.Origin}"
	header Access-Control-Allow-Credentials "true"
	header Access-Control-Expose-Headers "Content-Length, Content-Type"
}

# API - api.menuvo.app
api.menuvo.app {
	import cloudflare_tls
	import cors_api

	# Rate limiting for auth endpoints
	@auth_endpoints path /auth/* /trpc/auth.*
	rate_limit @auth_endpoints {
		zone auth_zone {
			key {client_ip}
			events 10
			window 1m
		}
	}

	# Rate limiting for general API
	rate_limit {
		zone api_zone {
			key {client_ip}
			events 200
			window 1m
		}
	}

	# Proxy to API instances
	reverse_proxy api-a:3000 api-b:3000 {
		import proxy_settings
		lb_policy least_conn
		health_uri /health
		health_interval 30s
		health_timeout 10s
	}

	import security_headers

	log {
		output file /var/log/caddy/api.log {
			roll_size 10MiB
			roll_keep 10
			roll_keep_for 720h
		}
		format json
		level INFO
	}

	encode gzip zstd
}

# Status Dashboard (Gatus)
status.menuvo.app {
	import cloudflare_tls

	reverse_proxy menuvo-gatus:8080

	rate_limit {
		zone status_zone {
			key {client_ip}
			events 100
			window 1m
		}
	}

	import security_headers

	log {
		output file /var/log/caddy/status.log {
			roll_size 10MiB
			roll_keep 10
			roll_keep_for 720h
		}
		format json
		level INFO
	}
}

# Beszel Monitoring Dashboard
monitor.menuvo.app {
	import cloudflare_tls

	reverse_proxy menuvo-beszel:8090

	rate_limit {
		zone beszel_zone {
			key {client_ip}
			events 100
			window 1m
		}
	}

	import security_headers

	log {
		output file /var/log/caddy/monitor.log {
			roll_size 10MiB
			roll_keep 10
			roll_keep_for 720h
		}
		format json
		level INFO
	}
}
