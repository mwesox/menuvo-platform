# Menuvo Production Docker Compose
# API-only deployment - SPAs deployed to Cloudflare Pages
#
# Architecture:
#   - api.menuvo.app      → API (Hono + tRPC)
#   - menuvo.app          → Shop (Cloudflare Pages)
#   - console.menuvo.app  → Console (Cloudflare Pages)
#   - business.menuvo.app → Business (Cloudflare Pages)
#   - status.menuvo.app   → Gatus (uptime monitoring)
#   - monitor.menuvo.app  → Beszel (host monitoring)
#
# VPS: Hetzner 8GB RAM

services:
  # PostgreSQL Database
  postgres:
    image: postgres:18-alpine
    container_name: menuvo-postgres
    restart: always
    mem_limit: 3g
    cpus: 2.0
    shm_size: 2gb
    environment:
      POSTGRES_USER: menuvo
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: menuvo
    volumes:
      - postgres_data:/var/lib/postgresql
    command: >
      postgres
      -c shared_buffers=2GB
      -c effective_cache_size=4GB
      -c maintenance_work_mem=256MB
      -c work_mem=16MB
      -c max_connections=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c log_min_duration_statement=1000
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U menuvo"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - menuvo

  # Redis for caching and queues
  redis:
    image: redis:8-alpine
    container_name: menuvo-redis
    restart: always
    mem_limit: 256m
    cpus: 0.5
    command: redis-server --appendonly yes --maxmemory 200mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - menuvo

  # Menuvo API - Instance A (rolling deploy)
  api-a:
    image: ghcr.io/mwesox/menuvo-api:${VERSION:-latest}
    container_name: menuvo-api-a
    restart: always
    mem_limit: 1g
    cpus: 1.0
    environment:
      NODE_ENV: production
      PORT: 3000
      ORIGIN: https://menuvo.app

      # Database
      DATABASE_URL: postgres://menuvo:${DB_PASSWORD}@postgres:5432/menuvo

      # Redis
      REDIS_URL: redis://redis:6379

      # Auth
      AUTH_SECRET: ${AUTH_SECRET}

      # External Storage (S3/R2)
      S3_ENDPOINT: ${S3_ENDPOINT}
      S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID}
      S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY}
      S3_BUCKET: ${S3_BUCKET}
      S3_FILES_BUCKET: ${S3_FILES_BUCKET}
      S3_BASE_URL: ${S3_BASE_URL}
      S3_REGION: ${S3_REGION:-auto}

      # Stripe
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET}
      STRIPE_WEBHOOK_SECRET_THIN: ${STRIPE_WEBHOOK_SECRET_THIN}

      # AI (OpenRouter)
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY}

      # Mollie
      MOLLIE_API_KEY: ${MOLLIE_API_KEY}
      MOLLIE_TEST_MODE: ${MOLLIE_TEST_MODE:-false}

    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - menuvo

  # Menuvo API - Instance B (rolling deploy)
  api-b:
    image: ghcr.io/mwesox/menuvo-api:${VERSION:-latest}
    container_name: menuvo-api-b
    restart: always
    mem_limit: 1g
    cpus: 1.0
    environment:
      NODE_ENV: production
      PORT: 3000
      ORIGIN: https://menuvo.app

      # Database
      DATABASE_URL: postgres://menuvo:${DB_PASSWORD}@postgres:5432/menuvo

      # Redis
      REDIS_URL: redis://redis:6379

      # Auth
      AUTH_SECRET: ${AUTH_SECRET}

      # External Storage (S3/R2)
      S3_ENDPOINT: ${S3_ENDPOINT}
      S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID}
      S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY}
      S3_BUCKET: ${S3_BUCKET}
      S3_FILES_BUCKET: ${S3_FILES_BUCKET}
      S3_BASE_URL: ${S3_BASE_URL}
      S3_REGION: ${S3_REGION:-auto}

      # Stripe
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET}
      STRIPE_WEBHOOK_SECRET_THIN: ${STRIPE_WEBHOOK_SECRET_THIN}

      # AI (OpenRouter)
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY}

      # Mollie
      MOLLIE_API_KEY: ${MOLLIE_API_KEY}
      MOLLIE_TEST_MODE: ${MOLLIE_TEST_MODE:-false}

    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - menuvo

  # Caddy Reverse Proxy - Custom build with rate limiting
  caddy:
    build:
      context: .
      dockerfile: Dockerfile.caddy
    container_name: menuvo-caddy
    restart: always
    mem_limit: 512m
    cpus: 0.5
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"  # HTTP/3
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
      - /var/log/caddy:/var/log/caddy
    depends_on:
      - api-a
      - api-b
    networks:
      - menuvo

  # Beszel Monitoring Hub
  beszel:
    image: henrygd/beszel:latest
    container_name: menuvo-beszel
    restart: unless-stopped
    mem_limit: 128m
    cpus: 0.25
    volumes:
      - beszel_data:/beszel_data
      - beszel_socket:/beszel_socket
    networks:
      - menuvo

  # Gatus Uptime Monitoring
  gatus:
    image: twinproduction/gatus:v5.33.1
    container_name: menuvo-gatus
    restart: unless-stopped
    mem_limit: 128m
    cpus: 0.25
    environment:
      GATUS_CONFIG_PATH: /config/gatus.yaml
      GATUS_TELEGRAM_TOKEN: ${GATUS_TELEGRAM_TOKEN}
      GATUS_TELEGRAM_CHAT_ID: ${GATUS_TELEGRAM_CHAT_ID}
    volumes:
      - ./gatus.yaml:/config/gatus.yaml:ro
      - gatus_data:/data
    networks:
      - menuvo

  # Beszel Agent (monitors this host)
  beszel-agent:
    image: henrygd/beszel-agent:latest
    container_name: menuvo-beszel-agent
    restart: unless-stopped
    mem_limit: 64m
    cpus: 0.25
    network_mode: host
    volumes:
      - beszel_socket:/beszel_socket
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      LISTEN: /beszel_socket/beszel.sock
      KEY: ${BESZEL_AGENT_KEY}

  # PostgreSQL Backups (S3/R2)
  postgres-backup:
    build:
      context: .
      dockerfile: Dockerfile.backup
    container_name: menuvo-postgres-backup
    restart: always
    mem_limit: 128m
    cpus: 0.25
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: menuvo
      DB_USER: menuvo
      DB_PASSWORD: ${DB_PASSWORD}
      BACKUP_S3_BUCKET: ${BACKUP_S3_BUCKET}
      BACKUP_S3_PREFIX: ${BACKUP_S3_PREFIX:-menuvo}
      BACKUP_S3_ENDPOINT: ${BACKUP_S3_ENDPOINT:-}
      BACKUP_S3_REGION: ${BACKUP_S3_REGION:-auto}
      BACKUP_KEEP_DAYS: ${BACKUP_KEEP_DAYS:-7}
      BACKUP_CRON: ${BACKUP_CRON:-0 3 * * *}
      AWS_ACCESS_KEY_ID: ${BACKUP_S3_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${BACKUP_S3_SECRET_ACCESS_KEY}
      AWS_DEFAULT_REGION: ${BACKUP_S3_REGION:-auto}
      AWS_EC2_METADATA_DISABLED: "true"
    volumes:
      - backups:/backups
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - menuvo

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  caddy_data:
    driver: local
  caddy_config:
    driver: local
  beszel_data:
    driver: local
  beszel_socket:
    driver: local
  gatus_data:
    driver: local
  backups:
    driver: local

networks:
  menuvo:
    driver: bridge
    driver_opts:
      com.docker.network.driver.mtu: 1450  # Hetzner optimized
